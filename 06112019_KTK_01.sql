IF EXISTS(SELECT NAME FROM sys.objects WHERE type = 'P' AND name = 'USP_TDS_GetTTUMMonthList')
DROP PROCEDURE USP_TDS_GetTTUMMonthList
GO 
CREATE PROCEDURE USP_TDS_GetTTUMMonthList 
@CLIENTID INT,
@ABCONCEPT BIT = 0,
@STAFFBRANCHCODE VARCHAR(10),
@VENDORBRANCHCODE VARCHAR(10)
AS  	
    BEGIN 
		DECLARE @VENDORBRANCHID INT = (SELECT BRANCHID FROM COMPANYBRANCH WHERE BRANCHCODE = @VENDORBRANCHCODE);	
		DECLARE @STAFFBRANCHID INT = (SELECT BRANCHID FROM COMPANYBRANCH WHERE BRANCHCODE = @STAFFBRANCHCODE);	
		
		--194N Related Changes Begin
		DECLARE @194NSECTIONID INT, @26QCALLOWED BIT;
		SET @194NSECTIONID = (SELECT SECTIONID FROM TAXSECTIONS WITH(NOLOCK) WHERE SECTIONNAME = '194N')
		IF(@CLIENTID = 3 OR @CLIENTID = 5 OR @CLIENTID = 10 OR @CLIENTID = 15 OR @CLIENTID = 16 OR @CLIENTID = 11)
			BEGIN
				SET @26QCALLOWED = 1
			END
		--194N Related Changes End
		 
		IF(@CLIENTID = 7)
			BEGIN
				 SELECT DISTINCT CASE WHEN MONTH(DEDUCTEDDATE) < 10 THEN '0' ELSE '' END + CAST(MONTH(DEDUCTEDDATE) AS VARCHAR) + SUBSTRING(CAST(YEAR(DEDUCTEDDATE) AS VARCHAR), 3, 2) AS MONTHYEAR,D.BRANCHID,BGLCODE AS FORMTYPE
				FROM DEDUCTIONDETAIL D WITH (NOLOCK)  
					INNER JOIN DEDCHALINK L WITH (NOLOCK) ON D.DEDUCTIONID = L.DEDUCTIONID  
					INNER JOIN TDSRATE TR WITH(NOLOCK) ON TR.BGLCODEID = D.BGLCODEID
					INNER JOIN CHALLANDETAIL C WITH (NOLOCK) ON L.CHALLANID = C.CHALLANID  
				WHERE    
					C.ISAUTOGENERATED = 1 AND ISOLTASINCLUDED = 0 AND C.BANKCHALLANNO IS NULL 
			END
		ELSE
			IF(@CLIENTID = 14 OR @CLIENTID = 15)
				BEGIN
					SELECT DISTINCT CASE WHEN MONTH(DEDUCTEDDATE) < 10 THEN '0' ELSE '' 
									END + CAST(MONTH(DEDUCTEDDATE) AS VARCHAR) + SUBSTRING(CAST(YEAR(DEDUCTEDDATE) AS VARCHAR), 3, 2) AS MONTHYEAR,
						D.BRANCHID, 'All' AS FORMTYPE
					FROM DEDUCTIONDETAIL D WITH (NOLOCK)  
					INNER JOIN DEDCHALINK L WITH (NOLOCK) ON D.DEDUCTIONID = L.DEDUCTIONID  
					INNER JOIN CHALLANDETAIL C WITH (NOLOCK) ON L.CHALLANID = C.CHALLANID  
					WHERE C.ISAUTOGENERATED = 1 AND ISOLTASINCLUDED = 0 AND C.BANKCHALLANNO IS NULL 
				END
			ELSE
				IF(@CLIENTID = 8 OR @CLIENTID = 17 OR @CLIENTID = 5 OR @CLIENTID = 3 OR (@CLIENTID = 1 AND @ABCONCEPT = 1))
					BEGIN
						SELECT DISTINCT CASE WHEN MONTH(DEDUCTEDDATE) < 10 THEN '0' 
											 ELSE '' END + CAST(MONTH(DEDUCTEDDATE) AS VARCHAR) 
											 + SUBSTRING(CAST(YEAR(DEDUCTEDDATE) AS VARCHAR), 3, 2) AS MONTHYEAR,
							D.RTBRANCHID AS BRANCHID,
							(
								CASE WHEN C.FORMID = 3 THEN '27Q' 
									 WHEN (C.FORMID = 2 AND C.SECTIONID = 5 AND D.ENTRYTYPE = 4) THEN '26QI' 
									 WHEN C.FORMID = 1 THEN '24Q' 
									 WHEN (@26QCALLOWED = 1 AND C.FORMID = 2 AND C.SECTIONID = @194NSECTIONID) THEN '26QC'
									 WHEN (@CLIENTID = 1 AND C.FORMID = 2 AND D.ENTRYTYPE = 4 AND C.SECTIONID <> 5) THEN '26QVS'									  
								ELSE '26QV' END
							) FORMTYPE
						INTO #FINAL
						FROM DEDUCTIONDETAIL D WITH (NOLOCK)  
							INNER JOIN DEDCHALINK L WITH (NOLOCK) ON D.DEDUCTIONID = L.DEDUCTIONID  
							INNER JOIN CHALLANDETAIL C WITH (NOLOCK) ON L.CHALLANID = C.CHALLANID  
						WHERE  C.ISAUTOGENERATED = 1 AND ISOLTASINCLUDED = 0 AND C.BANKCHALLANNO IS NULL 
						
						IF(@CLIENTID = 3)
							BEGIN
								SELECT * FROM #FINAL
								UNION
								SELECT TOP 1 MONTHYEAR, @VENDORBRANCHID AS BRANCHID, '26QV' FORMTYPE FROM #FINAL
								UNION
								SELECT TOP 1 MONTHYEAR, @VENDORBRANCHID AS BRANCHID, '26QVS' FORMTYPE FROM #FINAL
								UNION
								SELECT TOP 1 MONTHYEAR, @VENDORBRANCHID AS BRANCHID, '26QC' FORMTYPE FROM #FINAL
								UNION
								SELECT TOP 1 MONTHYEAR, @STAFFBRANCHID AS BRANCHID, '24Q' FORMTYPE FROM #FINAL
							END
						ELSE
							BEGIN
								SELECT * FROM #FINAL
							END
						
					 END
				ELSE
					BEGIN
						SELECT DISTINCT 
								CASE WHEN MONTH(DEDUCTEDDATE) < 10 THEN '0' ELSE '' END 
									+ CAST(MONTH(DEDUCTEDDATE) AS VARCHAR) 
									+ SUBSTRING(CAST(YEAR(DEDUCTEDDATE) AS VARCHAR), 3, 2) AS MONTHYEAR,
								D.BRANCHID,
								(CASE WHEN C.FORMID = 3 THEN '27Q' 
									  WHEN (C.FORMID = 2 AND C.SECTIONID = 5 AND D.ENTRYTYPE = 4) THEN '26QI' 
									  WHEN C.FORMID = 1 THEN '24Q' 
									  WHEN (@26QCALLOWED = 1 AND C.FORMID = 2 AND C.SECTIONID = @194NSECTIONID) THEN '26QC'
									  WHEN (@CLIENTID = 1 AND C.FORMID = 2 AND D.ENTRYTYPE = 4 AND C.SECTIONID <> 5) THEN '26QVS'									    
									  ELSE '26QV' END) FORMTYPE
						FROM DEDUCTIONDETAIL D WITH (NOLOCK)  
							INNER JOIN DEDCHALINK L WITH (NOLOCK) ON D.DEDUCTIONID = L.DEDUCTIONID  
							INNER JOIN CHALLANDETAIL C WITH (NOLOCK) ON L.CHALLANID = C.CHALLANID  
						WHERE  C.ISAUTOGENERATED = 1 AND ISOLTASINCLUDED = 0 AND C.BANKCHALLANNO IS NULL 
					 END
    END
   
  GO
  